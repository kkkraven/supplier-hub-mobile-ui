# Система RFQ (Request for Quote) - Настройка и использование

## Обзор

Система RFQ позволяет пользователям создавать запросы на предложение от поставщиков. Пользователи могут создавать черновики, прикреплять файлы с техническими требованиями и отправлять запросы поставщикам.

## Функциональность

### ✅ Реализовано

1. **Создание RFQ**
   - Форма создания с валидацией
   - Поля: название, описание, количество, дедлайн, приоритет, категория
   - Загрузка файлов (технические требования)
   - Создание черновиков

2. **Управление RFQ**
   - Просмотр списка всех RFQ пользователя
   - Фильтрация по статусу и приоритету
   - Поиск по названию и описанию
   - Редактирование черновиков
   - Удаление RFQ

3. **Файловые вложения**
   - Drag & drop загрузка файлов
   - Поддержка PDF, DOC, DOCX, XLS, XLSX, изображения
   - Максимальный размер файла: 20MB
   - Просмотр и удаление вложений

4. **Статусы RFQ**
   - `draft` - Черновик
   - `sent` - Отправлено
   - `quoted` - Получены предложения
   - `closed` - Закрыто

5. **Приоритеты**
   - `low` - Низкий
   - `medium` - Средний
   - `high` - Высокий

## Структура базы данных

### Таблица `rfqs`
```sql
CREATE TABLE rfqs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  category_id UUID NOT NULL REFERENCES categories(id),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  deadline TIMESTAMP WITH TIME ZONE NOT NULL,
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'sent', 'quoted', 'closed')),
  priority TEXT NOT NULL DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Таблица `rfq_attachments`
```sql
CREATE TABLE rfq_attachments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  rfq_id UUID NOT NULL REFERENCES rfqs(id) ON DELETE CASCADE,
  file_name TEXT NOT NULL,
  file_url TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  file_type TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Настройка

### 1. Установка зависимостей

```bash
cd web
npm install
```

Добавленные зависимости:
- `@hookform/resolvers` - Валидация форм
- `date-fns` - Работа с датами
- `react-dropzone` - Drag & drop загрузка файлов
- `zod` - Схемы валидации

### 2. Настройка Supabase Storage

Создайте bucket для хранения файлов RFQ:

```sql
-- В Supabase Dashboard -> Storage
-- Создайте bucket с именем "rfq-attachments"
-- Установите публичный доступ для чтения
```

### 3. Применение миграций

```bash
# Примените миграцию для таблицы вложений
supabase db push
```

### 4. Настройка RLS (Row Level Security)

Политики безопасности уже включены в миграцию:

- Пользователи могут видеть только свои RFQ
- Пользователи могут создавать RFQ только для себя
- Пользователи могут редактировать только свои черновики
- Пользователи могут удалять только свои RFQ

## Использование

### Создание RFQ

1. Перейдите на страницу `/rfq`
2. Нажмите "Создать RFQ"
3. Заполните форму:
   - **Название** - краткое описание запроса
   - **Категория** - выберите подходящую категорию
   - **Описание** - подробное описание требований
   - **Количество** - требуемое количество единиц
   - **Приоритет** - важность запроса
   - **Дедлайн** - дата, до которой нужны предложения
4. При необходимости прикрепите файлы с техническими требованиями
5. Сохраните как черновик или сразу отправьте

### Управление RFQ

- **Просмотр списка**: `/rfq` - все RFQ пользователя
- **Просмотр деталей**: `/rfq/[id]` - детальная информация о конкретном RFQ
- **Редактирование**: `/rfq/[id]/edit` - редактирование черновика
- **Создание нового**: `/rfq/create` - создание нового RFQ

### Фильтрация и поиск

На странице списка RFQ доступны:
- Поиск по названию и описанию
- Фильтр по статусу
- Фильтр по приоритету
- Отображение количества найденных RFQ

## Компоненты

### Основные компоненты

- `RFQForm` - форма создания/редактирования RFQ
- `RFQList` - список RFQ с фильтрацией
- `RFQDetail` - детальная информация о RFQ
- `FileUpload` - компонент загрузки файлов

### Хуки

- `useRFQ` - основной хук для работы с RFQ
- `useToast` - уведомления

### Типы

- `RFQ` - основной тип RFQ
- `RFQAttachment` - тип вложения
- `RFQQuote` - тип предложения (для будущего использования)

## Безопасность

- Все операции защищены RLS
- Пользователи могут работать только со своими RFQ
- Валидация на клиенте и сервере
- Безопасная загрузка файлов с проверкой типов

## Расширение функциональности

### Планируемые улучшения

1. **Система предложений**
   - Получение предложений от поставщиков
   - Сравнение предложений
   - Принятие/отклонение предложений

2. **Уведомления**
   - Email уведомления о новых предложениях
   - Напоминания о дедлайнах
   - Уведомления об изменении статуса

3. **Аналитика**
   - Статистика по RFQ
   - Отчеты по эффективности
   - Анализ предложений

4. **Интеграция с поставщиками**
   - Автоматическая отправка RFQ поставщикам
   - API для получения предложений
   - Система рейтингов поставщиков

## Устранение неполадок

### Частые проблемы

1. **Файлы не загружаются**
   - Проверьте настройки Supabase Storage
   - Убедитесь, что bucket "rfq-attachments" создан
   - Проверьте размер файла (максимум 20MB)

2. **Ошибки валидации**
   - Проверьте заполнение обязательных полей
   - Убедитесь, что дедлайн в будущем
   - Проверьте формат количества (должно быть положительным числом)

3. **Проблемы с правами доступа**
   - Проверьте настройки RLS
   - Убедитесь, что пользователь авторизован
   - Проверьте политики безопасности

### Логи

Для отладки используйте:
- Консоль браузера для клиентских ошибок
- Supabase Dashboard -> Logs для серверных ошибок
- Network tab для проверки API запросов
