# Cursor Rules — Factura Supplier Hub (Cloudflare)

## PROJECT TRUTH
- Продукт: закрытый каталог проверенных китайских швейных фабрик.
- Ключевая логика: контакты (название, адрес, WeChat/тел.) видны ТОЛЬКО ПОСЛЕ оплаты.
- MVP-флоу: Catalog → Filters → RFQ chat → PDF contract → Test escrow (Stripe).
- Данные: стартово 5–70 фабрик, реальные поля: city, segment, moq, lead_time_days, interaction_level.
- Языки UI: RU/EN (минимум), без фантазийных цифр/лоромов.

## STACK & RUNTIME (обязательно)
- Next.js 14 (App Router) + TypeScript (strict: true).
- Деплой: Cloudflare Pages через `@cloudflare/next-on-pages`.
- Рантайм только Edge-совместимый: **НЕ** использовать Node-API (fs, path, crypto Node).
- Backend-данные: Supabase (Postgres, Auth, Realtime, Storage). Все запросы через fetch.
- Платежи: Stripe (test) в Edge/Pages Functions; верификация сигнатуры без Node Buffer.
- UI: Tailwind + shadcn/ui. Шрифт Inter. Radius 12, grid 8dp. Доступность AA.

## FOLDERS & FILES
- `/app` — страницы Next (App Router).
- `/components` — изолированные UI.
- `/lib` — клиенты (supabase, stripe), схемы zod.
- `/public` — статические ассеты.
- `/functions` — Pages Functions для вебхуков (`/functions/stripe-webhook.ts`).
- `/scripts` — сиды/миграции.
- Тесты: `__tests__` с Vitest + RTL.

## NEXT CONFIG (обязательно)
- `next.config.mjs`: включить experimental edge-runtime для роутов с серверными actions, запрет Node APIs.
- Не подключать `images.domains`, если нет реальных доменов.

## CLOUDFlare BUILD
- package.json scripts:
  - `"build:cf": "npx @cloudflare/next-on-pages@latest build --experimental-minify"`
  - `"preview:cf": "npx wrangler pages dev .vercel/output/static"`
- Pages settings: Build Command = `pnpm build:cf`; Output dir = `.vercel/output/static`; Node 20.

## ENV VARS (только то, что реально нужно)
- `NEXT_PUBLIC_SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE` (ТОЛЬКО в Functions; не утекать в клиент!)
- `SUPABASE_ANON_KEY`
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`
- Никогда не логировать секреты, не дублировать .env в исходниках.

## DATA & ACCESS
- Supabase: включить RLS; публичное чтение только небезопасных полей.
- Поля контактов фабрики помечать `sensitive`, отдавать ТОЛЬКО если `subscription.active = true`.
- На карточке до оплаты: показывать city, segment, moq, lead_time_days, interaction_level; скрывать название/адрес/контакты (blur/lock).

## PAYMENT & PAYWALL
- После успешной оплаты Stripe → webhook (Pages Function) меняет `subscription.active = true` для пользователя.
- UI получает состояние по Realtime и разблюривает контакты. При окончании подписки — блюрит обратно.
- Никаких «free tier» и «trial» в коде; Starter = $300 за 3 фабрики (лимит хранить в БД).

## CODING RULES (экономим токены)
1. Писать **инкрементально**: сначала список затронутых файлов и diff-план, затем код ТОЛЬКО этих файлов.
2. Не переписывать весь проект, не форматировать чужие файлы, не генерировать lock-файлы.
3. **ИЗОЛЯЦИЯ ИЗМЕНЕНИЙ**: работать только с одним блоком/компонентом за раз, не трогать глобальные стили и базовые компоненты без крайней необходимости.
4. **ЛОКАЛЬНЫЕ ИСПРАВЛЕНИЯ**: при исправлении стилей создавать локальные классы или использовать className prop вместо изменения базовых UI компонентов.
5. **ПЕРЕИСПОЛЬЗУЕМЫЕ БЛОКИ**: создавать компоненты, которые можно использовать несколько раз в разных местах, избегать дублирования кода и лишних сущностей.
6. Без длинных комментариев/повторов ТЗ; максимум 1–2 строки пояснения на файл.
7. Никаких картинок/base64/гиф — использовать плейсхолдеры и svg-иконки.
8. Минимизировать зависимости. Запрещено: `fs`, `path`, heavy UI kits, moment, lodash-full.

## QUALITY GATES
- TypeScript strict, ESLint + Prettier без ошибок.
- Vitest coverage ≥ 70% на utils и Paywall guard.
- Lighthouse (desktop) ≥ 90 performance/accessibility на Catalog.
- I18n: строки через простой dict (RU/EN).

## PAGES (минимально)
- `/` Hero с оффером «3 фабрики — $300» + калькулятор выгоды.
- `/catalog` сетка карточек (lock для контактов).
- `/factory/[id]` подробная карточка, RFQ кнопка (ведёт к paywall при неактивной подписке).
- `/pricing` Starter/Growth/Pro с чёткими лимитами.
- `/account` статус подписки, счёт, лимит разблокированных фабрик.

## COMMIT & PR
- Conventional commits (`feat:`, `fix:`, `chore:`).
- Каждый крупный блок отдельным PR с кратким checklist.
- В PR описывать ENV/миграции, чтобы не ломать деплой.

## DEPLOY SAFETY
- Никогда не пушить `.env*`.
- Перед деплоем запускать: `pnpm typecheck && pnpm test && pnpm build:cf`.
- Если Stripe webhook не настроен — UI не должен открывать контакты (defensive UI).
